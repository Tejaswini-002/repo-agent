<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Repo Monitor ‚Äî Live PR Events</title>
    <style>
      * { box-sizing: border-box; }
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        min-height: 100vh;
      }
      .container {
        max-width: 1000px;
        margin: 0 auto;
      }
      .header {
        background: white;
        border-radius: 8px;
        padding: 20px 24px;
        margin-bottom: 20px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .header h1 {
        margin: 0;
        font-size: 24px;
        color: #0366d6;
      }
      .header-right {
        display: flex;
        gap: 12px;
        align-items: center;
      }
      .status {
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 13px;
        font-weight: 500;
      }
      .status.connected {
        background: #e6ffed;
        color: #034a16;
      }
      .status.disconnected {
        background: #ffeef0;
        color: #660e1a;
      }
      .stats {
        background: white;
        border-radius: 8px;
        padding: 12px 16px;
        margin-bottom: 20px;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      }
      .stat-card {
        text-align: center;
        padding: 12px;
        background: #f6f8fa;
        border-radius: 4px;
      }
      .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: #0366d6;
      }
      .stat-label {
        font-size: 12px;
        color: #586069;
        margin-top: 4px;
      }
      .controls {
        background: white;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 20px;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      }
      button {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        background: #0366d6;
        color: white;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s;
      }
      button:hover {
        background: #0256c7;
      }
      button:active {
        background: #023fa8;
      }
      button.secondary {
        background: #6a737d;
      }
      button.secondary:hover {
        background: #586069;
      }
      #events {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .event {
        background: white;
        border-left: 4px solid #0366d6;
        border-radius: 6px;
        padding: 16px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        transition: transform 0.2s, box-shadow 0.2s;
      }
      .event:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      }
      .event.opened { border-left-color: #28a745; }
      .event.synchronize { border-left-color: #6f42c1; }
      .event.closed { border-left-color: #d73a49; }
      .event.reopened { border-left-color: #fd7e14; }
      .event-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 8px;
      }
      .event-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
      }
      .event-badge.opened {
        background: #e6ffed;
        color: #034a16;
      }
      .event-badge.synchronize {
        background: #f0e5ff;
        color: #420e5e;
      }
      .event-badge.closed {
        background: #ffeef0;
        color: #660e1a;
      }
      .event-badge.reopened {
        background: #fff8f1;
        color: #654321;
      }
      .event-title {
        font-size: 15px;
        font-weight: 600;
        color: #24292e;
        margin: 0 0 8px 0;
        word-break: break-word;
      }
      .event-meta {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 12px;
        font-size: 12px;
        color: #586069;
        margin-bottom: 8px;
      }
      .meta-item {
        display: flex;
        align-items: center;
        gap: 4px;
      }
      .meta-label {
        font-weight: 500;
        color: #24292e;
      }
      .event-url {
        display: inline-block;
        margin-top: 8px;
        padding: 6px 12px;
        background: #f6f8fa;
        border-radius: 4px;
        font-size: 12px;
        text-decoration: none;
        color: #0366d6;
      }
      .event-url:hover {
        background: #e1e4e8;
      }
      .files-section {
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid #e1e4e8;
      }
      .files-title {
        font-size: 12px;
        font-weight: 600;
        color: #24292e;
        margin-bottom: 8px;
      }
      .files-list {
        background: #f6f8fa;
        border-radius: 4px;
        padding: 8px;
        font-size: 11px;
        font-family: 'Monaco', 'Courier New', monospace;
        max-height: 200px;
        overflow-y: auto;
        line-height: 1.5;
      }
      .file-item {
        padding: 2px 0;
        color: #24292e;
      }
      .file-status {
        display: inline-block;
        width: 20px;
        font-weight: 600;
      }
      .file-status.M { color: #0366d6; }
      .file-status.A { color: #28a745; }
      .file-status.D { color: #d73a49; }
      .file-status.R { color: #6f42c1; }
      .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #586069;
        font-size: 14px;
      }
      .empty-state svg {
        width: 48px;
        height: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üîç Repo Monitor</h1>
        <div class="header-right">
          <div class="status connected" id="status">‚óè Connected</div>
        </div>
      </div>

      <div class="stats" id="stats">
        <div class="stat-card">
          <div class="stat-value" id="total-events">0</div>
          <div class="stat-label">Total Events</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="pr-events">0</div>
          <div class="stat-label">PR Events</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="event-time">‚Äî</div>
          <div class="stat-label">Last Event</div>
        </div>
      </div>

      <div class="controls">
        <button onclick="clearEvents()">Clear Events</button>
        <button class="secondary" onclick="downloadPDF()">üìÑ Download PDF</button>
        <button class="secondary" onclick="refreshStats()">üîÑ Refresh Stats</button>
        <button class="secondary" onclick="toggleAutoScroll()" id="auto-scroll-btn">‚è∏ Pause Auto-Scroll</button>
      </div>

      <div id="events"></div>
      <div id="empty" class="empty-state" style="display:none;">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4v.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <p>Waiting for PR events...</p>
      </div>
    </div>

    <script>
      const eventsEl = document.getElementById('events');
      const emptyEl = document.getElementById('empty');
      const statusEl = document.getElementById('status');
      let autoScroll = true;
      let eventCount = 0;
      let lastEventTime = null;

      const es = new EventSource('/events');
      
      es.onopen = () => {
        statusEl.textContent = '‚óè Connected';
        statusEl.className = 'status connected';
      };
      
      es.onerror = () => {
        statusEl.textContent = '‚óè Disconnected';
        statusEl.className = 'status disconnected';
      };

      es.onmessage = (e) => {
        try {
          const obj = JSON.parse(e.data);
          const el = document.createElement('div');
          el.className = 'event';
          
          if (obj.event_name === 'pull_request' && obj.summary) {
            const s = obj.summary;
            const action = s.action || 'unknown';
            el.classList.add(action);
            const ts = obj.timestamp ? new Date(obj.timestamp).toLocaleString() : 'N/A';
            lastEventTime = ts;

            el.innerHTML = `
              <div class="event-header">
                <div>
                  <span class="event-badge ${action}">${action}</span>
                  <h3 class="event-title">${escapeHtml(s.title || 'Untitled')}</h3>
                </div>
              </div>
              <div class="event-meta">
                <div class="meta-item">
                  <span class="meta-label">Repo:</span> ${escapeHtml(s.repo || 'N/A')}
                </div>
                <div class="meta-item">
                  <span class="meta-label">PR #:</span> ${s.pr_number || 'N/A'}
                </div>
                <div class="meta-item">
                  <span class="meta-label">Author:</span> ${escapeHtml(s.user || 'N/A')}
                </div>
                <div class="meta-item">
                  <span class="meta-label">Files Changed:</span> ${s.changed_files_count || 0}
                </div>
                <div class="meta-item">
                  <span class="meta-label">Time:</span> ${ts}
                </div>
              </div>`;
            
            if (s.url) {
              el.innerHTML += `<a href="${escapeHtml(s.url)}" target="_blank" class="event-url">View PR ‚Üí</a>`;
            }

            if (s.files && s.files.length > 0) {
              const fileHtml = s.files.slice(0, 50).map(f => {
                const status = f.status || '?';
                let statusClass = '';
                if (status === 'M') statusClass = 'M';
                else if (status === 'A') statusClass = 'A';
                else if (status === 'D') statusClass = 'D';
                else if (status === 'R') statusClass = 'R';
                return `<div class="file-item"><span class="file-status ${statusClass}">${status}</span> ${escapeHtml(f.filename || 'N/A')}</div>`;
              }).join('');
              el.innerHTML += `<div class="files-section"><div class="files-title">Changed Files (${s.files.length}):</div><div class="files-list">${fileHtml}</div></div>`;
            }

            eventCount++;
            emptyEl.style.display = 'none';
          } else {
            el.innerHTML = `<pre>${JSON.stringify(obj, null, 2)}</pre>`;
          }
          
          eventsEl.insertBefore(el, eventsEl.firstChild);
          if (autoScroll && eventsEl.firstChild) {
            eventsEl.firstChild.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          }
          updateStats();
        } catch (err) {
          console.error('parse error', err);
        }
      };

      function escapeHtml(s) {
        const div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
      }

      function updateStats() {
        document.getElementById('total-events').textContent = eventCount;
        document.getElementById('pr-events').textContent = eventsEl.children.length;
        document.getElementById('event-time').textContent = lastEventTime ? new Date(lastEventTime).toLocaleTimeString() : '‚Äî';
      }

      function clearEvents() {
        if (confirm('Clear all events?')) {
          eventsEl.innerHTML = '';
          eventCount = 0;
          emptyEl.style.display = 'block';
          updateStats();
        }
      }

      function downloadPDF() {
        window.location.href = '/pdf';
      }

      function refreshStats() {
        fetch('/stats')
          .then(r => r.json())
          .then(d => {
            document.getElementById('total-events').textContent = d.total_events;
            document.getElementById('pr-events').textContent = d.pr_events;
          })
          .catch(err => console.error('stats fetch error', err));
      }

      function toggleAutoScroll() {
        autoScroll = !autoScroll;
        const btn = document.getElementById('auto-scroll-btn');
        btn.textContent = autoScroll ? '‚è∏ Pause Auto-Scroll' : '‚ñ∂ Resume Auto-Scroll';
      }

      window.addEventListener('load', () => {
        updateStats();
        refreshStats();
        if (eventsEl.children.length === 0) {
          emptyEl.style.display = 'block';
        }
      });
    </script>
  </body>
</html>

name: Repo Monitor Agent

on:
  push:
    branches: ["**"]
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Run monitor (prints commit + changed files)
        env:
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_REF: ${{ github.ref }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          python scripts/monitor.py

      - name: Upload monitor events artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: repo-monitor-events-${{ github.run_id }}
          path: repo-monitor-events.jsonl

      - name: Commit monitor events back to a branch
        if: always()
        run: |
          if [ -f repo-monitor-events.jsonl ]; then
            BRANCH=repo-monitor-events-${{ github.run_id }}
            git checkout -b "$BRANCH"
            git add repo-monitor-events.jsonl || true
            git commit -m "ci: add monitor events from run $GITHUB_RUN_ID" || echo "no changes to commit"
            git push origin "$BRANCH" || echo "push failed or no permission"
          else
            echo "No events file to commit"
          fi

      - name: Comment on PR (PR events only)
        if: ${{ github.event_name == 'pull_request' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_SHA: ${{ github.sha }}
        run: |
          python scripts/comment_pr.py
